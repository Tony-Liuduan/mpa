<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview app server entry
 * @author liuduan
 * @Date 2020-05-07 16:11:38
 * @LastEditTime 2020-05-17 00:39:41
 */
import path from 'path';
import config from 'config';
import Koa from 'koa';
import favicon from 'koa-favicon';
import serve from 'koa-static';
import render from 'koa-swig';
import co from 'co';
import bodyParser from 'koa-bodyparser';
import { historyApiFallback } from 'koa2-connect-history-api-fallback';

import {
    responseIndex,
    response5xx,
    response404,
} from './middlewares/page';
import * as routers from './routers';
import {
    errorLogger,
} from './utils/logger';


const app = new Koa();


const PORT = config.get('port');




// 当未捕获的 JavaScript 异常一直冒泡回到事件循环时，会触发 'uncaughtException' 事件
process.on('uncaughtException', (err, origin) => {
    errorLogger.error(err);
});

process.on('unhandledRejection', (reason, promise) => {
    errorLogger.error('promise 未处理的拒绝：', promise, '原因：', reason);
});

// 每当 Promise 被拒绝并且错误处理函数附加到它（例如，使用 promise.catch()）晚于一个 Node.js 事件循环时，就会触发 'rejectionHandled' 事件。
process.on('rejectionHandled', (promise) => {
    errorLogger.error(promise);
});

// http.on error:
// only triggered when err handler middleware not triggered
app.on('error', (err, ctx) => {
    errorLogger.error(err);
});

// err-5xx handler middleware
app.use(response5xx);

// err-404 handler middleware
app.use(response404);




app.use(favicon(path.join(process.cwd(), 'favicon.ico')));
app.use(historyApiFallback({ whiteList: ['/', '/books', '/api'] }));
app.use(serve(path.join(__dirname, '../web/assets')));
app.context.render = co.wrap(render({
    root: path.join(__dirname, '../web/views'),
    autoescape: true,
    cache: process.env.NODE_ENV === 'development' ? false : 'memory',
    ext: 'html',
    writeBody: false,
    // varControls: ['[[', ']]'], // 如需修改模板标识符时使用
}));




app.use(responseIndex);
app.use(bodyParser());
for (const route of Object.values(routers)) {
    app.use(route.routes(), route.allowedMethods())
}




app.listen(PORT, () => {
    console.log('🍺服务启动成功', port);
})</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ApiRespnse.html">ApiRespnse</a></li><li><a href="BooksController.html">BooksController</a></li><li><a href="ChainOfResponsibility.html">ChainOfResponsibility</a></li><li><a href="ModalBooks.html">ModalBooks</a></li></ul><h3>Global</h3><ul><li><a href="global.html#actionCreate">actionCreate</a></li><li><a href="global.html#actionIndex">actionIndex</a></li><li><a href="global.html#actionUpdate">actionUpdate</a></li><li><a href="global.html#actionView">actionView</a></li><li><a href="global.html#createItem">createItem</a></li><li><a href="global.html#deleteItem">deleteItem</a></li><li><a href="global.html#isApiRequset">isApiRequset</a></li><li><a href="global.html#isHtmlRequset">isHtmlRequset</a></li><li><a href="global.html#queryItem">queryItem</a></li><li><a href="global.html#queryList">queryList</a></li><li><a href="global.html#updateItem">updateItem</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.4</a> on Sun May 17 2020 00:49:33 GMT+0800 (中国标准时间)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
